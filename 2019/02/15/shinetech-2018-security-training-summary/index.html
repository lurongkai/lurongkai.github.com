
 <!DOCTYPE HTML>
<html lang="default">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  
    <title>shinetech 2018 security training summary | lurongkai&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Lu Rongkai">
    

    
    <meta name="description" content="「关注软件开发中的安全」  18年10月底的时候，我在Shinetech Software内部做了一场在线的培训，主要关注的是在软件开发过程中，对于安全方面的工程实践，并不算是很深入的探讨，更多的是一些极不易察觉但又很常见的疏忽，这篇博客整理出来。">
<meta name="keywords" content="security">
<meta property="og:type" content="article">
<meta property="og:title" content="shinetech 2018 security training summary">
<meta property="og:url" content="https://lurongkai.github.io/2019/02/15/shinetech-2018-security-training-summary/index.html">
<meta property="og:site_name" content="lurongkai&#39;s blog">
<meta property="og:description" content="「关注软件开发中的安全」  18年10月底的时候，我在Shinetech Software内部做了一场在线的培训，主要关注的是在软件开发过程中，对于安全方面的工程实践，并不算是很深入的探讨，更多的是一些极不易察觉但又很常见的疏忽，这篇博客整理出来。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://lurongkai.github.io/photos/2019-01-15-shinetech-2018-security-training-summary/op_hijack1.png">
<meta property="og:image" content="https://lurongkai.github.io/photos/2019-01-15-shinetech-2018-security-training-summary/op_hijack2.png">
<meta property="og:updated_time" content="2019-02-15T05:22:45.644Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="shinetech 2018 security training summary">
<meta name="twitter:description" content="「关注软件开发中的安全」  18年10月底的时候，我在Shinetech Software内部做了一场在线的培训，主要关注的是在软件开发过程中，对于安全方面的工程实践，并不算是很深入的探讨，更多的是一些极不易察觉但又很常见的疏忽，这篇博客整理出来。">
<meta name="twitter:image" content="https://lurongkai.github.io/photos/2019-01-15-shinetech-2018-security-training-summary/op_hijack1.png">

    
    <link rel="alternative" href="/atom.xml" title="lurongkai&#39;s blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="lurongkai&#39;s blog">lurongkai&#39;s blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search">
						<input type="hidden" name="q" value="site:lurongkai.github.io">
					</form>
					
					</li>
				</ul>
			</ul></nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope="" itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/02/15/shinetech-2018-security-training-summary/" title="shinetech 2018 security training summary" itemprop="url">shinetech 2018 security training summary</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Lu Rongkai" target="_blank" itemprop="author">Lu Rongkai</a>
		
  </p><p class="article-time">
    <time datetime="2019-02-15T05:10:40.000Z" itemprop="datePublished"> Published 2019-02-15</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一切漏洞都可以是注入漏洞"><span class="toc-number">1.</span> <span class="toc-text">一切漏洞都可以是注入漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#不要相信来自用户的数据"><span class="toc-number">1.1.</span> <span class="toc-text">不要相信来自用户的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不要相信外部-第三方-的数据"><span class="toc-number">1.2.</span> <span class="toc-text">不要相信外部(第三方)的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#也不要过于相信自己的数据"><span class="toc-number">1.3.</span> <span class="toc-text">也不要过于相信自己的数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一切-非业务-缺陷都是缺少检查"><span class="toc-number">2.</span> <span class="toc-text">一切(非业务)缺陷都是缺少检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前端检查"><span class="toc-number">2.1.</span> <span class="toc-text">前端检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后端验证"><span class="toc-number">2.2.</span> <span class="toc-text">后端验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复杂的业务状态检查利器-状态机"><span class="toc-number">2.3.</span> <span class="toc-text">复杂的业务状态检查利器:状态机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#人的因素"><span class="toc-number">3.</span> <span class="toc-text">人的因素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#弱口令"><span class="toc-number">3.1.</span> <span class="toc-text">弱口令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#未验证的第三库引用"><span class="toc-number">3.2.</span> <span class="toc-text">未验证的第三库引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#credentials及源代码管理"><span class="toc-number">3.3.</span> <span class="toc-text">credentials及源代码管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一定要做环境隔离"><span class="toc-number">3.4.</span> <span class="toc-text">一定要做环境隔离!</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在实践中"><span class="toc-number">4.</span> <span class="toc-text">在实践中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后"><span class="toc-number">5.</span> <span class="toc-text">最后</span></a></li></ol>
		
		</div>
		
		<p><strong>「关注软件开发中的安全」</strong></p>
<blockquote>
<p>18年10月底的时候，我在Shinetech Software内部做了一场在线的培训，主要关注的是在软件开发过程中，对于安全方面的工程实践，并不算是很深入的探讨，更多的是一些极不易察觉但又很常见的疏忽，这篇博客整理出来。</p>
</blockquote>
<a id="more"></a>
<h2 id="一切漏洞都可以是注入漏洞"><a href="#一切漏洞都可以是注入漏洞" class="headerlink" title="一切漏洞都可以是注入漏洞"></a>一切漏洞都可以是注入漏洞</h2><h3 id="不要相信来自用户的数据"><a href="#不要相信来自用户的数据" class="headerlink" title="不要相信来自用户的数据"></a>不要相信来自用户的数据</h3><p><strong>e.g. SQL</strong></p>
<p>如果我们碰到了如下一段代码片断，用于实现将用户通过id从数据库中查询出来，有经验的你一定知道有什么严重的问题：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var id = ctx.query['id'];</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">USERS</span> <span class="keyword">WHERE</span> <span class="keyword">ID</span> = <span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>
<p>这段代码从用户的http请求中取出id(查询字符串)，之后然后通过sql拼接生产一条合法的查询语句并执行，正常的请求可能是这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /users?id=66721855</span><br><span class="line">[&#123;</span><br><span class="line">    &quot;id&quot;: 66721855,</span><br><span class="line">    &quot;name&quot;: &quot;lurongkai&quot;,</span><br><span class="line">    &quot;addr&quot;: &quot;Tian Jin&quot;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>那么此时执行的是<code>SELECT * FROM USERS WHERE ID = 66721855</code>，这没有问题，但是如果精心构造一个特殊的query string值呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /users?id=1%20OR%201%3D1</span><br><span class="line">1%20OR%201%3D1 --(uri decode) -&gt; 1 OR 1=1</span><br></pre></td></tr></table></figure>
<p>这样，最后执行的sql就变成了<code>SELECT * FROM USERS
WHERE ID = 1 OR 1=1</code>，不解释了，典型的sql注入，一定留意。</p>
<blockquote>
<p>想像一下<code>DELETE FROM POSTS WHERE ID = id</code>……</p>
</blockquote>
<p>解决的方法其实很简单，大部分的驱动都是支持<code>param</code>构造的，比如可以这么做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM USERS WHERE ID = @ID</span><br><span class="line">conn.execute(sql, &#123; ID: id &#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有同学会嘲笑，说这都2019年了，谁还在用sql拼接，我们都ORM甚至nosql了。别大意，有很多你想像不到的场景仍然在大量使用sql拼接，这是一块神奇土壤，而且nosql不见得一定安全，请看下一个例子。</p>
</blockquote>
<p><strong>e.g. Mongo</strong></p>
<p>假设我们有一个不规范的查询接口，使用了POST来查询payments数据，并在body中传递查询的条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /payments</span><br><span class="line">&#123;</span><br><span class="line">    &quot;f1&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">=&gt;</span><br><span class="line">[&#123;</span><br><span class="line">    &quot;id&quot;: &quot;5a69b8e0817870269d5fe82c&quot;,</span><br><span class="line">    &quot;amount&quot;: &quot;100&quot;,</span><br><span class="line">    &quot;f1&quot;: 1,</span><br><span class="line">    &quot;createdAtUtc&quot;: &quot;2018-10-01T10:10:10.000&quot;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>返回的是通过给定的条件过滤后的数据。一般此类的接口会限定只能查询自身的数据，所以除非烂到无法拯救，通常是不会查询到其他用户的数据的。后端api的实现可能会是如此：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var q = ctx.body;</span><br><span class="line">var query = &#123; uid: uid, …q &#125;;</span><br><span class="line">db.collection[&apos;payments&apos;].find(q);</span><br></pre></td></tr></table></figure>
<p>uid来自authentication/authorization中间件。那么最终执行的mongo查询会是<code>db.collection[&#39;payments&#39;].find({ uid: 1 f1: 1 })</code>。接下来我们来构造特殊数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/POST /payments</span><br><span class="line">&#123;</span><br><span class="line">    uid: &#123;</span><br><span class="line">        $ne: -1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行起来会是<code>db.collection[&#39;payments&#39;].find({ uid: { $ne: -1 } })</code>，查到了所有用户的数据。</p>
<p>这其实不算是个好例子，js的锅可能更大一些。我想在这里表达的是，mongo的<strong>操作符</strong>是存在注入风险的，要留意。</p>
<p><strong>e.g. XSS</strong></p>
<p>跨站脚本注入非常常见，假设有以下接口:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;my blog&quot;,</span><br><span class="line">    &quot;content&quot;: &quot;hello, shinetech&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口用来发布一篇博客，当前端开始展示该博客的时候，对应的可能是这样的代码:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span>…<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"blog-body"</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"template"</span> <span class="attr">type</span>=<span class="string">"x-tmpl-mustache"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">section</span>&gt;</span>&#123;&#123;&#123; body &#125;&#125;&#125;<span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    $.get('/blogs/1', function(data) &#123;</span></span><br><span class="line"><span class="undefined">        var rendered = Mustache.render(template, data);</span></span><br><span class="line"><span class="undefined">        $('#blog-body').html(rendered);</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们把逻辑剥离开，那么刚才那篇博客对应的html是:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span>…<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"blog-body"</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">section</span>&gt;</span>hello, shinetech<span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接下来开始构造特殊数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;my blog&quot;,</span><br><span class="line">    &quot;content&quot;: &quot;hello, shinetech</span><br><span class="line">      &lt;script&gt;/* DO EVIL */&lt;/script&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，渲染后的html是:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span>…<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"blog-body"</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">            hello, shinetech</span><br><span class="line">            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">/* DO EVIL */</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>解决的办法也是比较简单，渲染的时候不要使用<code>{{{}}}</code>，而是使用<code>{{}}</code>就好了。</p>
<blockquote>
<p>这背后的逻辑其实是这样：mustache不是个例，而是所有的前端页面的渲染都不应该相信用户的输入，都必需要做encoding或者危险标签剔除(这个很有难度)，如果嫌麻烦还可以使用markdown，但不应该直接将用户的数据渲染出来。</p>
</blockquote>
<p>最终处理后的html会变成:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span>…<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"blog-body"</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">            hello, shinetech</span><br><span class="line">            %3Cscript%3E%2F%2A+DO+EVIL+%2A%2F%3C%2Fscript%3E</span><br><span class="line">        <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>e.g. Bounds Checking</strong></p>
<p>边界检查简直是重灾区，不少祸事都是因为没有做严格的边界检查造成的。</p>
<p>假设有一个用于转账的接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /transfer</span><br><span class="line">&#123;</span><br><span class="line">    &quot;trans&quot;: [&#123;</span><br><span class="line">        &quot;toUser&quot;: &quot;5a69b8f865bdcc26a2ca32ee&quot;, // user a</span><br><span class="line">        &quot;amount&quot;: 100</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        &quot;toUser&quot;: &quot;5a69b8f865bdcc26a2ca32ef&quot;, // user b</span><br><span class="line">        &quot;amount&quot;: 200</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后端的实现是这样的（假设js是一门没有溢出检查的语言）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">processTransfer</span>(<span class="params">model</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> balance = getBalance();</span><br><span class="line">    <span class="keyword">const</span> total = _.sumBy(model.trans, t =&gt; t.amount);</span><br><span class="line">    <span class="comment">//假定当前用户的余额是2000</span></span><br><span class="line">    <span class="keyword">if</span> (total &gt; balance) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'insufficient balance '</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// maybe in transaction</span></span><br><span class="line">    <span class="keyword">await</span> withdraw(ctx.user.id, total);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> t <span class="keyword">of</span> model.trans) &#123;</span><br><span class="line">        <span class="keyword">await</span> deposit(t.toUser, t.amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在正常情况下，执行的结果应该是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Before:</span><br><span class="line">Self:                        = 2000</span><br><span class="line">User a:                      = 500</span><br><span class="line">User b:                      = 500</span><br><span class="line"></span><br><span class="line">After:</span><br><span class="line">Self: 2000 - ((100) + (200)) = 1700</span><br><span class="line">User a: 500 + (100)          = 600</span><br><span class="line">User b: 500 + (200)          = 700</span><br></pre></td></tr></table></figure>
<p>接下来，开始构造特殊数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /transfer</span><br><span class="line">&#123;</span><br><span class="line">    &quot;trans&quot;: [&#123;</span><br><span class="line">        &quot;toUser&quot;: &quot;5a69b8f865bdcc26a2ca32ee&quot;,</span><br><span class="line">        &quot;amount&quot;: -100</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        &quot;toUser&quot;: &quot;5a69b8f865bdcc26a2ca32ef&quot;,</span><br><span class="line">        &quot;amount&quot;: 200</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是，结果变为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Before:</span><br><span class="line">Self:                         = 2000</span><br><span class="line">User a:                       = 500</span><br><span class="line">User b:                       = 500</span><br><span class="line"></span><br><span class="line">After:</span><br><span class="line">Self: 2000 - ((-100) + (200)) = 1900</span><br><span class="line">User a: 500 + (—100)          = 400</span><br><span class="line">User b: 500 + (200)           = 700</span><br></pre></td></tr></table></figure>
<p>再比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /transfer</span><br><span class="line">&#123;</span><br><span class="line">    &quot;trans&quot;: [&#123;</span><br><span class="line">        &quot;toUser&quot;: &quot;5a69b8f865bdcc26a2ca32ee&quot;,</span><br><span class="line">        &quot;amount&quot;: 2147483647</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        &quot;toUser&quot;: &quot;5a69b8f865bdcc26a2ca32ef&quot;,</span><br><span class="line">        &quot;amount&quot;: 1</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果会变成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Before:</span><br><span class="line">Self:                       = 2000</span><br><span class="line">User a:                     = 500</span><br><span class="line">User b:                     = 500</span><br><span class="line"></span><br><span class="line">After:</span><br><span class="line">Self: 2000 - ((2147483647) + (1)) = -2147481648</span><br><span class="line">User a: 500 + (2147483647)        = -2147483149</span><br><span class="line">User b: 500 + (1)                 = 501</span><br></pre></td></tr></table></figure>
<p>第一段数据显示，业务逻辑没有针对负值进行处理，第二段说明没有处理溢出的情况。</p>
<p>为什么会溢出？</p>
<p>32位整型的最大值为<code>2^31-1 2147483647</code>，最小值为<code>-2^31 -2147483648</code>，我们举例说明<code>Int32.MaxValue + 1</code>的计算过程:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原码:</span><br><span class="line">    0_1111111111111111111111111111111</span><br><span class="line">+   0_0000000000000000000000000000001</span><br><span class="line">=   1_0000000000000000000000000000000</span><br></pre></td></tr></table></figure>
<p>之后对结果（补码）转换为原码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">补 -&gt; 原(后31位取反加1)</span><br><span class="line">=   1_10000000000000000000000000000000</span><br><span class="line">=   - 2^31 = -2147483648</span><br></pre></td></tr></table></figure>
<p>再举个<code>2147483647 + (-2147483648) = -1</code>的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">运算时:</span><br><span class="line">    0_1111111111111111111111111111111</span><br><span class="line">+   1_0000000000000000000000000000000（内存中，负数都是补码表示）</span><br><span class="line">=   1_1111111111111111111111111111111</span><br><span class="line"></span><br><span class="line">补 -&gt; 原:</span><br><span class="line">    1_0000000000000000000000000000001</span><br><span class="line">    - 1</span><br></pre></td></tr></table></figure>
<p>所幸，现在的编程语言大多对溢出有了很好的控制，例如会抛出异常，但是针对边界检查上仍然需要留意。</p>
<h3 id="不要相信外部-第三方-的数据"><a href="#不要相信外部-第三方-的数据" class="headerlink" title="不要相信外部(第三方)的数据"></a>不要相信外部(第三方)的数据</h3><p><strong>e.g. 微信支付</strong></p>
<p>一般的流程是：</p>
<ol>
<li>web|app: GET /wx/params获取支付参数</li>
<li>web: (jsapi) 跳转到微信支付页面, app: (唤起微信)</li>
<li>用户在页面或者app完成支付并跳回web|app</li>
<li>服务端等待微信服务器的回调，并完成对应业务</li>
<li>web|app拉取最新数据</li>
</ol>
<p>通常的实现为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 微信支付回调接口</span></span><br><span class="line">router.post(<span class="string">'/wx/cb'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> rc = ctx.request.body.return_code || <span class="string">''</span> === <span class="string">'SUCCESS'</span>;</span><br><span class="line">    <span class="keyword">const</span> rm = ctx.request.body.return_msg || <span class="string">''</span> === <span class="string">'OK'</span>;</span><br><span class="line">    <span class="keyword">if</span> (!rc || !rm) &#123;</span><br><span class="line">        <span class="comment">// 支付失败的业务逻辑，并回复微信服务器</span></span><br><span class="line">        ctx.body = xml(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;xml&gt;</span></span><br><span class="line"><span class="string">  &lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;</span></span><br><span class="line"><span class="string">  &lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;</span></span><br><span class="line"><span class="string">&lt;/xml&gt;100</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新数据状态 &amp; 更新订单或者其它业务</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>那么我们看看，发现支付的回调接口没有验证来源，其实是可以伪造支持通知请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">curl \</span><br><span class="line">  -H <span class="string">"Content-Type:application/json"</span> \</span><br><span class="line">  -X POST \</span><br><span class="line">  --data <span class="string">'&#123; \</span></span><br><span class="line"><span class="string">    "return_code": "SUCCESS", \</span></span><br><span class="line"><span class="string">    "return_msg": "OK", \</span></span><br><span class="line"><span class="string">    "appid: "", \                    // 可从params里取得</span></span><br><span class="line"><span class="string">    "mch_id: "", \                   // 可从params里取得</span></span><br><span class="line"><span class="string">    "nonce_str: "", \                // 可从params里取得</span></span><br><span class="line"><span class="string">    "sign: "", \                     // 伪造</span></span><br><span class="line"><span class="string">    "openid": "", \                  // 可从params里取得</span></span><br><span class="line"><span class="string">    "trade_type: "", \               // JSAPI、NATIVE、APP</span></span><br><span class="line"><span class="string">    "bank_type: "CMB_CREDIT", \      // 伪造</span></span><br><span class="line"><span class="string">    "total_fee: 100, \               // 可从params里取得</span></span><br><span class="line"><span class="string">    "transaction_id: "wx2018100110101082741", \ // 伪造</span></span><br><span class="line"><span class="string">    "out_trade_no: "", \             // 可从params里取得</span></span><br><span class="line"><span class="string">    "time_end: "20181001101010" \</span></span><br><span class="line"><span class="string">  &#125;'</span> \</span><br><span class="line">  http://demo.api.com/wx/cb</span><br></pre></td></tr></table></figure>
<p>对于回调类，尤其是第三方的数据来源，一定要做身份或合法性验证。</p>
<h3 id="也不要过于相信自己的数据"><a href="#也不要过于相信自己的数据" class="headerlink" title="也不要过于相信自己的数据"></a>也不要过于相信自己的数据</h3><p><strong>e.g. 运营商劫持</strong></p>
<p>很多只使用<code>http</code>协议的app会经常发现页面上有很多第三方的广告或<code>widget</code>这是由于运营商的动态注入造成的。</p>
<p><img src="/photos/2019-01-15-shinetech-2018-security-training-summary/op_hijack1.png" width="300px"><br><img src="/photos/2019-01-15-shinetech-2018-security-training-summary/op_hijack2.png" width="300px"></p>
<p>这些http流量在运营商看来就是透明的，所以为了防微杜渐，干脆全走<code>https</code>更加简单。</p>
<p><strong>e.g. 双向验证</strong></p>
<p>启用<code>https</code>后事情还没有结束，有可能还会涉及到中间人攻击问题，尤其是app的后端api，传统的过程是这样:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Browser &lt;------- HTTPS -------&gt; Server</span><br></pre></td></tr></table></figure>
<p>被中间人攻击后就变成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Browser &lt;-------HTTPS -------&gt; (Attacker)</span><br><span class="line">                                    |</span><br><span class="line">                                    | // 证书替换?</span><br><span class="line">                                    |</span><br><span class="line">Server &lt;------- HTTPS -------&gt; (Attacker)</span><br></pre></td></tr></table></figure>
<p>解决的办法倒也是简单，直接将公钥打包在app中，通讯时强制检查公私钥就行，会安全许多。</p>
<h2 id="一切-非业务-缺陷都是缺少检查"><a href="#一切-非业务-缺陷都是缺少检查" class="headerlink" title="一切(非业务)缺陷都是缺少检查"></a>一切(非业务)缺陷都是缺少检查</h2><h3 id="前端检查"><a href="#前端检查" class="headerlink" title="前端检查"></a>前端检查</h3><p>前端页面的检查是很有必要的，除了能改善用户体验，还能部分避免后端脆弱所造成的严重问题。但是不能只依靠前端的检查，如果前端/后端的检查有个比重的话，我可能会给出<code>1:9</code>这么毫不夸张的比例：</p>
<ul>
<li>input required?</li>
<li>input type?</li>
<li>input format? email, phone, number precision/max/min</li>
<li>password complexity?</li>
<li>input dependencies?</li>
<li>date format?</li>
<li>timezone convert?</li>
<li>…</li>
</ul>
<p>如果忽略这些</p>
<h3 id="后端验证"><a href="#后端验证" class="headerlink" title="后端验证"></a>后端验证</h3><p>当数据是从用户端产生并提交到服务端时，需要做很多的合法性检查，因为你无法盲目的去相信用户数据：</p>
<ul>
<li>illegal fields cleaning</li>
<li>format checking</li>
<li>required/dependencies checking</li>
<li>range/bounds checking</li>
<li>signature/certification verifying</li>
<li>anti-forgery token checking(防止重放)</li>
<li>business logic precondition checking</li>
<li>…</li>
</ul>
<p>能做到这些，就能避免很大一部分的逻辑缺陷和试探。</p>
<p><strong>e.g. asp.net core mvc</strong></p>
<p>一个良好实现后端检查的例子（使用C#语言）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookInputModel</span> &#123;</span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Title &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    [<span class="meta">RegularExpression(@<span class="meta-string">"^\d&#123;3&#125;-\d-\d&#123;3,4&#125;-\d&#123;4,5&#125;-\d$"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Isbn &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    [<span class="meta">Range(0, 1000)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Route(<span class="meta-string">"api/books"</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line">[<span class="meta">AutoValidateAntiforgeryToken</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BooksController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">HttpPost</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">""</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Post</span>(<span class="params">[FromBody]BookInputModel model</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ModelState.IsValid) &#123;</span><br><span class="line">            <span class="keyword">return</span> BadRequest(<span class="string">"book data invalid"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">await</span> _bookRepository.HasByIsbn(model.Isbn)) &#123;</span><br><span class="line">            <span class="keyword">return</span> BadRequest(<span class="string">"the specified book already exists"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> serviceDto = Mapper.Map&lt;Book&gt;(model); <span class="comment">// 数据清洗</span></span><br><span class="line">        <span class="keyword">var</span> book = <span class="keyword">await</span> _bookService.Create(serviceDto);</span><br><span class="line">        <span class="keyword">var</span> bookDisplayModel = Mapper.Map&lt;BookDisplayModel&gt;(book); <span class="comment">// 数据清洗</span></span><br><span class="line">        <span class="keyword">return</span> CreatedAtAction(<span class="string">"Get"</span>, bookDisplayModel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">"&#123;id&#125;"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Get</span>(<span class="params">[FromRoute]<span class="keyword">string</span> id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> book = <span class="keyword">await</span> _bookRepository.Find(id);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == book) &#123;</span><br><span class="line">            <span class="keyword">return</span> NotFound();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Ok(Mapper.Map&lt;BookDisplayModel&gt;(book));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="复杂的业务状态检查利器-状态机"><a href="#复杂的业务状态检查利器-状态机" class="headerlink" title="复杂的业务状态检查利器:状态机"></a>复杂的业务状态检查利器:状态机</h3><p>如果我来推荐的话，对于复杂一些的业务，推荐使用状态机建模，避免自顶向下一条龙式的实现，极易出错而且还不易排查和文档化。</p>
<p>一个假想的例子是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">router.put(<span class="string">'/some/business'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> input = ctx.request.body;</span><br><span class="line">    <span class="keyword">if</span> (!isValid(input)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'input invalid'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> stateInput = parseRaw(input);</span><br><span class="line">    <span class="keyword">const</span> state = <span class="keyword">await</span> loadState(stateInput);</span><br><span class="line">    <span class="keyword">const</span> expected = <span class="keyword">await</span> decideNext(input.action);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">await</span> state.canProcess(expected, input)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'business checking failed, forbidden'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> state.goNext(expected, input);</span><br><span class="line">    <span class="keyword">await</span> saveState(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ss = state.snapshot;</span><br><span class="line">    <span class="keyword">const</span> mapper = <span class="keyword">new</span> Mapper();</span><br><span class="line">    <span class="keyword">const</span> res = mapper.mapTo(&#123; <span class="attr">ns</span>: <span class="string">'some/business'</span>, <span class="attr">data</span>: ss &#125;);</span><br><span class="line">    ctx.body = res;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当然，并不存在这样一种现成的框架，但是如果有精力，我可能会去做这么一个基础模块出来，但是背后的理念是通用的。</p>
<h2 id="人的因素"><a href="#人的因素" class="headerlink" title="人的因素"></a>人的因素</h2><h3 id="弱口令"><a href="#弱口令" class="headerlink" title="弱口令"></a>弱口令</h3><p>有没有见过下面这些眼熟的密码？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">12345678</span><br><span class="line">1234567890</span><br><span class="line">111111</span><br><span class="line">aaaaaa</span><br><span class="line">1qaz2wsx#EDC</span><br><span class="line">admin</span><br><span class="line">hello2018</span><br><span class="line">[name]112233</span><br><span class="line">[phone]</span><br></pre></td></tr></table></figure>
<p>建议还是花一些时间，对内部使用的密码例如数据库连接密码等集中做一次审计，避免因弱口令造成的事故。如果有能力的话，同时建议定期更换密码，并限制到极少数人知道或者通过安全的硬件保存。</p>
<h3 id="未验证的第三库引用"><a href="#未验证的第三库引用" class="headerlink" title="未验证的第三库引用"></a>未验证的第三库引用</h3><p>一些关于引用第三库的小tips：</p>
<ul>
<li>Open Source库可能更安全一些</li>
<li>下载二进制包时，注意和官方的gpg签名做对比(有良心的都提供)</li>
<li>去官方下载，不要去xx网盘，宁肯使用有节操的镜像节点</li>
<li>在使用npm, maven, nuget等registry时，如果下载的是小众包，那么仍然需要慎重，你看到的代码不代表是包中使用的代码，不放心请手动build</li>
<li>使用互操作时，请更加留意底层的原生库，一个不留神，反手就是一个缓冲区溢出，尽量避免Interop</li>
<li>docker镜像请使用官方出品，小众镜像请手动docker build(这事儿爆过很严重的事件: ref-&gt; docker123321)</li>
</ul>
<h3 id="credentials及源代码管理"><a href="#credentials及源代码管理" class="headerlink" title="credentials及源代码管理"></a>credentials及源代码管理</h3><p>一些关于凭证和SCM的小tips：</p>
<ul>
<li>不要以明文存密码，使用hash，必要时还可以加salt</li>
<li>CI/CD上使用的凭证要注意隐藏，否则会在build日志中看到，例如使用Jenkins的凭证管理</li>
<li>调用第三方api的凭证不要直接放在源代码中，环境变量是一种选项，或者更好的配置管理方式</li>
<li>目前github会帮你扫描是否有敏感信息签入代码库，但是仍然需要留意，避免出现第二个”华住”</li>
<li>不要轻易把私有仓库变成公有仓库，你并不是很清楚提交历史里有什么敏感信息，有必要的话清除历史并检查后新开仓库</li>
<li>保护好企业的自动化工具，提升工具的安全性，例如保护好Jenkins，保护好内部npm、maven、nuget</li>
</ul>
<h3 id="一定要做环境隔离"><a href="#一定要做环境隔离" class="headerlink" title="一定要做环境隔离!"></a>一定要做环境隔离!</h3><p>一些其它的tips：</p>
<ul>
<li>生产、测试、开发，不同环境应该使用的所有凭证都不相同</li>
<li>JWT签发token一定留意Audience，子站A签发的token不见得是给子站B用的</li>
<li>不同的环境使用不同的JWT Signing Key，这是信仰</li>
<li>除非不得已，不同的环境间应该完全阻止互通，防止跳板攻击</li>
<li>生产应该只有极少数人可以操作，尽量避免开发人员操作</li>
<li>不要在生产环境上调试错误，除非根本没在代码中做日志</li>
<li>不要在生产上安装各种无用的东西，比如安个360浏览器…再比如安个不知名的根证书，脆弱就是一瞬间</li>
<li>必要时，连source-map都不要暴露在生产上，dbg符号文件更不能泄露，否则和泄露代码一样</li>
</ul>
<h2 id="在实践中"><a href="#在实践中" class="headerlink" title="在实践中"></a>在实践中</h2><p>一些在实践中的小tips：</p>
<ul>
<li>慎重选择加密方式，必要的话请使用高强度的非对称加密，并妥善保存私钥<br>代码中的写的日志一定要定期的梳理，不要把敏感信息(例如用户密码)写到日志中(github自己出过这问题)</li>
<li>定期升级依赖库，虽然有可能会有bug，但是和安全比起来，仍然值得投入<br>类似HeartBleed的漏洞不是普通开发者能避免的，我们能做的就是第一时间升级，然后做好自己的安全</li>
<li>开发时，时刻进行人格分裂，站在攻击者的角度，思考一下可能会如何攻击</li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>需要强调两点：</p>
<ul>
<li>安全投资是很昂贵的，我们能做的只能是尽量从开发层面降低伤害</li>
<li>开发环节、运维环节、基础设施，任何一层都有可能会出现问题</li>
</ul>
<p>强烈建议！使用容器或虚拟化技术。</p>
<blockquote>
<p>安全遵循木桶理论，缺一块儿都会降低整体可用性</p>
</blockquote>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/training/">training</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/security/">security</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://lurongkai.github.io/2019/02/15/shinetech-2018-security-training-summary/" data-title="shinetech 2018 security training summary | lurongkai&#39;s blog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2017/03/02/retional-team-with-communication/" title="理性沟通的团队">
 <strong>下一篇：</strong><br> 
 <span>理性沟通的团队
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一切漏洞都可以是注入漏洞"><span class="toc-number">1.</span> <span class="toc-text">一切漏洞都可以是注入漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#不要相信来自用户的数据"><span class="toc-number">1.1.</span> <span class="toc-text">不要相信来自用户的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不要相信外部-第三方-的数据"><span class="toc-number">1.2.</span> <span class="toc-text">不要相信外部(第三方)的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#也不要过于相信自己的数据"><span class="toc-number">1.3.</span> <span class="toc-text">也不要过于相信自己的数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一切-非业务-缺陷都是缺少检查"><span class="toc-number">2.</span> <span class="toc-text">一切(非业务)缺陷都是缺少检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前端检查"><span class="toc-number">2.1.</span> <span class="toc-text">前端检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后端验证"><span class="toc-number">2.2.</span> <span class="toc-text">后端验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复杂的业务状态检查利器-状态机"><span class="toc-number">2.3.</span> <span class="toc-text">复杂的业务状态检查利器:状态机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#人的因素"><span class="toc-number">3.</span> <span class="toc-text">人的因素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#弱口令"><span class="toc-number">3.1.</span> <span class="toc-text">弱口令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#未验证的第三库引用"><span class="toc-number">3.2.</span> <span class="toc-text">未验证的第三库引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#credentials及源代码管理"><span class="toc-number">3.3.</span> <span class="toc-text">credentials及源代码管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一定要做环境隔离"><span class="toc-number">3.4.</span> <span class="toc-text">一定要做环境隔离!</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在实践中"><span class="toc-number">4.</span> <span class="toc-text">在实践中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后"><span class="toc-number">5.</span> <span class="toc-text">最后</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/lurongkai" target="_blank" title="Github">Github</a>
            
          </li>
        
          <li>
            
            	<a href="/software-designing-perspective" target="_blank" title="软件和设计">软件和设计</a>
            
          </li>
        
          <li>
            
            	<a href="/human-being-and-life-perspective" target="_blank" title="人类和生活">人类和生活</a>
            
          </li>
        
    </ul>
</div>

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/productivity/" title="productivity">productivity<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/collaboration/" title="collaboration">collaboration<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/security/" title="security">security<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/F/" title="F#">F#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Functional-Programming/" title="Functional-Programming">Functional-Programming<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/asynchronous/" title="asynchronous">asynchronous<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/javascript/" title="javascript">javascript<sup>1</sup></a></li>
			
		
		</ul>
</div>


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/asp-net/" title="asp-net">asp-net<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/dot-net/" title="dot-net">dot-net<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/essays/" title="essays">essays<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/joke/" title="joke">joke<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/life/" title="life">life<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/other/" title="other">other<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/productivity/" title="productivity">productivity<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/reproduce/" title="reproduce">reproduce<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/tips/" title="tips">tips<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/training/" title="training">training<sup>1</sup></a></li>
		  
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer">
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m lurongkai on Github <br>
			</p>
	</section>
	 
	<div class="social-font">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/lurongkai" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="Lu Rongkai">Lu Rongkai</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'lurongkai';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?74291727c50712cd2fcc785ef807bd0c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
